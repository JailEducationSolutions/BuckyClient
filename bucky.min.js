/*! bucky 0.2.8 */
(function(){var a,b,c,d,e,f,g=[].slice;d=function(){return"undefined"!=typeof module&&null!==module&&!("undefined"!=typeof window&&null!==window?window.module:void 0)},f=function(){var a,b,c,e;return d()?(a=require("xmlhttprequest").XMLHttpRequest,b=process.hrtime(),1e3*(b[0]+b[1]/1e9)):null!=(c=null!=(e=window.performance)&&"function"==typeof e.now?e.now():void 0)?c:+new Date},c=+new Date,b=function(){var a,b,c,d,e,f,h;for(a=arguments[0],d=2<=arguments.length?g.call(arguments,1):[],f=0,h=d.length;h>f;f++){c=d[f];for(b in c)e=c[b],a[b]=e}return a},e=function(){var a,b;return a=1<=arguments.length?g.call(arguments,0):[],null!=("undefined"!=typeof console&&null!==console&&null!=(b=console.log)?b.call:void 0)?console.log.apply(console,a):void 0},e.error=function(){var a,b;return a=1<=arguments.length?g.call(arguments,0):[],null!=("undefined"!=typeof console&&null!==console&&null!=(b=console.error)?b.call:void 0)?console.error.apply(console,a):void 0},a=function(){var a,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M;if(o={host:"/bucky",maxInterval:3e4,aggregationInterval:5e3,decimalPrecision:3,sendLatency:!1,sample:1,active:!0},F={},!d()&&(a="function"==typeof document.querySelector?document.querySelector("[data-bucky-host],[data-bucky-page],[data-bucky-requests]"):void 0))for(F={host:a.getAttribute("data-bucky-host"),pagePerformanceKey:a.getAttribute("data-bucky-page"),requestsKey:a.getAttribute("data-bucky-requests")},K=["pagePerformanceKey","requestsKey"],I=0,J=K.length;J>I;I++)t=K[I],"true"===(null!=(L=F[t])?L.toString().toLowerCase():void 0)||""===F[t]?F[t]=!0:"false"===(null!=(M=F[t])?M.toString().toLowerCase():void 0)&&(F[t]=null);return y=b({},o,F),j={timer:"ms",gauge:"g",counter:"c"},h=y.active,(G=function(){return h=y.active&&Math.random()<y.sample})(),i=[],E=function(a){return b(y,a),("sample"in a||"active"in a)&&G(),y},A=function(a,b){return null==b&&(b=y.decimalPrecision),Math.round(a*Math.pow(10,b))/Math.pow(10,b)},z={},s=!1,l=function(){return z={}},p=function(a,b,c){var d,e;if(h)return d=1,a in z&&("counter"===c?b+=z[a].value:(d=null!=(e=z[a].count)?e:d,d++,b=z[a].value+(b-z[a].value)/d)),z[a]={value:b,type:c,count:d},n()},C=null,x=null,q=function(){return clearTimeout(C),clearTimeout(x),x=setTimeout(q,y.maxInterval),C=null,B()},r={},D=function(a){return r=a},k=function(){return r={}},n=function(){return clearTimeout(C),C=setTimeout(q,y.aggregationInterval),null==x?x=setTimeout(q,y.maxInterval):void 0},w=function(a,b){var c,e,g,h,i,j,k,l,m,n,o;e=d()||window.XMLHttpRequest&&(window.XMLHttpRequest.defake||"withCredentials"in new window.XMLHttpRequest),d()?l=!0:(h=/^(https?:\/\/[^\/]+)/i.exec(y.host),h?(j=h[1],l=j===""+document.location.protocol+"//"+document.location.host?!0:!1):l=!0),m=f(),c="";for(i in a)n=a[i],c+=""+i+":"+n+"\n";k=l||e||null==("undefined"!=typeof window&&null!==window?window.XDomainRequest:void 0)?new(null!=(o="undefined"!=typeof window&&null!==window?window.XMLHttpRequest:void 0)?o:XMLHttpRequest):new window.XDomainRequest,k.bucky={track:!1},k.open("POST",""+y.host+"/v1/send",!0),k.setRequestHeader("Content-Type","text/plain");for(i in b)g=b[i],k.addEventListener(i,g,!1);for(i in r)g=r[i],k.addEventListener(i,g,!1);return k.addEventListener("load",function(){return H(f()-m)},!1),k.send(c),k},s=!1,B=function(){var a,b,c,d,f,g;if(!h)return void e("Would send bucky queue");if(s)return void e("Sending in progress, aborting");if(0===Object.keys(z).length)return void e("Queue Empty");c={};for(t in z)d=z[t],i.push({path:t,count:d.count,type:d.type,value:d.value}),null!=j[d.type]?(f=d.value,("gauge"===(g=d.type)||"timer"===g)&&(f=A(f)),c[t]=""+f+"|"+j[d.type],1!==d.count&&(c[t]+="@"+A(1/d.count,5))):e.error("Type "+d.type+" not understood by Bucky");return b=function(a){return s=!1,z={}},a=function(a){return s=!1},s=!0,w(c,{load:b,error:a})},u=!1,H=function(a){return y.sendLatency&&!u?(p("bucky.latency",a,"timer"),u=!0,setTimeout(function(){return u=!1},3e5)):void 0},v=function(a){var b,d,j,m,n,o,r,u,w,x;null==a&&(a=""),b=function(b){return(null!=a?a.length:void 0)?a+"."+b:b},o=function(a,c,d){return null==d&&(d="gauge"),null==c||null==a?void e.error("Can't log "+a+":"+c):p(b(a),c,d)},w={TIMES:{},send:function(a,b){return o(a,b,"timer")},time:function(){var a,b,c,d,e;return e=arguments[0],a=arguments[1],c=arguments[2],b=4<=arguments.length?g.call(arguments,3):[],w.start(e),d=function(){return w.stop(e)},b.splice(0,0,d),a.apply(c,b)},timeSync:function(){var a,b,c,d,e;return d=arguments[0],a=arguments[1],c=arguments[2],b=4<=arguments.length?g.call(arguments,3):[],w.start(d),e=a.apply(c,b),w.stop(d),e},wrap:function(a,b){return null!=b?function(){var c;return c=1<=arguments.length?g.call(arguments,0):[],w.timeSync.apply(w,[a,b,this].concat(g.call(c)))}:function(b){return function(){var c;return c=1<=arguments.length?g.call(arguments,0):[],w.timeSync.apply(w,[a,b,this].concat(g.call(c)))}}},start:function(a){return w.TIMES[a]=f()},stop:function(a){var b;return null==w.TIMES[a]?void e.error("Timer "+a+" ended without having been started"):(b=f()-w.TIMES[a],w.TIMES[a]=void 0,w.send(a,b))},stopwatch:function(a,b){var c,d;return null!=b?d=function(){return+new Date}:(d=f,b=d()),c=b,{mark:function(c,e){var f;return null==e&&(e=0),f=d(),a&&(c=a+"."+c),w.send(c,f-b+e)},split:function(b,e){var f;return null==e&&(e=0),f=d(),a&&(b=a+"."+b),w.send(b,f-c+e),c=f}}},mark:function(a,b){var c;return null==b&&(b=+new Date),c=w.navigationStart(),w.send(a,b-c)},navigationStart:function(){var a,b,d;return null!=(a="undefined"!=typeof window&&null!==window&&null!=(b=window.performance)&&null!=(d=b.timing)?d.navigationStart:void 0)?a:c},responseEnd:function(){var a,b,d;return null!=(a="undefined"!=typeof window&&null!==window&&null!=(b=window.performance)&&null!=(d=b.timing)?d.responseEnd:void 0)?a:c},now:function(){return f()}},d=function(a,b){return null==b&&(b=1),o(a,b,"counter")},u=!1,r=function(a){var b,c,d,e,f,g=this;if(null==("undefined"!=typeof window&&null!==window&&null!=(d=window.performance)?d.timing:void 0))return!1;if(u)return!1;if(a&&a!==!0||(a=n.urlToKey(document.location.toString())+".page"),"uninitialized"===(e=document.readyState)||"loading"===e)return"function"==typeof window.addEventListener&&window.addEventListener("load",function(){return setTimeout(function(){return r.call(g,a)},500)},!1),!1;u=!0,b=window.performance.timing.navigationStart,f=window.performance.timing;for(t in f)c=f[t],"number"==typeof c&&w.send(""+a+"."+t,c-b);return!0},n={transforms:{mapping:{guid:/\/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi,sha1:/\/[0-9a-f]{40}/gi,md5:/\/[0-9a-f]{32}/gi,id:/\/[0-9;_\-]+/g,email:/\/[^\/]+@[^\/]+/g,domain:[/\/[^\/]+\.[a-z]{2,3}\//gi,"/"]},enabled:["guid","sha1","md5","id","email","domain"],enable:function(a,b,c){return null==c&&(c=""),null!=b&&(this.mapping[a]=[b,c]),this.enabled.splice(0,0,a)},disable:function(a){var b,c,d;d=this.enabled;for(b in d)if(c=d[b],c===a)return void this.enabled.splice(b,1)}},sendReadyStateTimes:function(a,b){var c,d,e,f,g,h,i,j;if(null!=b){d={1:"sending",2:"headers",3:"waiting",4:"receiving"},e={},f=null;for(c in b)h=b[c],null!=f&&null!=d[c]&&(e[d[c]]=h-f),f=h;j=[];for(g in e)i=e[g],j.push(w.send(""+a+"."+g,i));return j}},urlToKey:function(a,b,c){var d,f,g,h,i,j,k,l,m,o;for(a=a.replace(/https?:\/\//i,""),h=/([^\/:]*)(?::\d+)?(\/[^\?#]*)?.*/i.exec(a),d=h[1],i=null!=(m=h[2])?m:"",o=n.transforms.enabled,k=0,l=o.length;l>k;k++)g=o[k],f=n.transforms.mapping[g],null!=f?"function"!=typeof f?(f instanceof RegExp&&(f=[f,""]),i=i.replace(f[0],f[1])):i=f(i,a,b,c):e.error("Bucky Error: Attempted to enable a mapping which is not defined: "+g);return i=decodeURIComponent(i),i=i.replace(/[^a-zA-Z0-9\-\.\/ ]+/g,"_"),j=d+i.replace(/[\/ ]/g,"."),j=j.replace(/(^\.)|(\.$)/g,""),j=j.replace(/\.com/,""),j=j.replace(/www\./,""),c&&(j=c+"."+j),b&&(j=j+"."+b.toLowerCase()),j=j.replace(/\.\./g,".")},getFullUrl:function(a,b){return null==b&&(b=document.location),/^\//.test(a)?b.hostname+a:/https?:\/\//i.test(a)?a:b.toString()+a},monitor:function(a){var b,c,g;return a&&a!==!0||(a=n.urlToKey(document.location.toString())+".requests"),c=this,b=function(b){var e,g,h,i,j,k,l,m;return l=b.type,m=b.url,g=b.event,i=b.request,h=b.readyStateTimes,j=b.startTime,null!=j?(e=f()-j,m=c.getFullUrl(m),k=c.urlToKey(m,l,a),o(k,e,"timer"),c.sendReadyStateTimes(k,h),null!=(null!=i?i.status:void 0)?(i.status>12e3?d(""+k+".0"):0!==i.status&&d(""+k+"."+i.status.toString().charAt(0)+"xx"),d(""+k+"."+i.status)):void 0):void 0},g=window.XMLHttpRequest,window.XMLHttpRequest=function(){var a,c,d,h,i,j;d=new g;try{h=null,c={},i=d.open,d.open=function(a,g,j){var k;try{c[0]=f(),d.addEventListener("readystatechange",function(){return c[d.readyState]=f()},!1),d.addEventListener("loadend",function(e){return null==d.bucky||d.bucky.track!==!1?b({type:a,url:g,event:e,startTime:h,readyStateTimes:c,request:d}):void 0},!1)}catch(l){k=l,e.error("Bucky error monitoring XHR open call",k)}return i.apply(d,arguments)},j=d.send,d.send=function(){return h=f(),j.apply(d,arguments)}}catch(k){a=k,e.error("Bucky error monitoring XHR",a)}return d}}},m=function(b){var c;return null==b&&(b=""),c=null!=a?a:"",c&&b&&(c+="."),b&&(c+=b),v(c)},j={send:o,count:d,timer:w,now:f,requests:n,sendPagePerformance:r,flush:q,clearQueue:l,setHandlers:D,isSending:s,clearHandlers:k,setOptions:E,options:y,history:i,active:h};for(t in j)x=j[t],m[t]=x;return m},m=v(),y.pagePerformanceKey&&m.sendPagePerformance(y.pagePerformanceKey),y.requestsKey&&m.requests.monitor(y.requestsKey),m},"function"==typeof define&&define.amd?define(a):"object"==typeof exports?module.exports=a():window.Bucky=a()}).call(this);